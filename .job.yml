---
version: 2.0
builds:
  build-debian-package-ub22.04:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make pkg"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:
    artifacts:
        - /device-metrics-exporter/bin/amdgpu-exporter_1.2.0_ubuntu_22.04_amd64.deb

  build-debian-package-ub24.04:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make UBUNTU_VERSION=noble pkg"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:
    artifacts:
        - /device-metrics-exporter/bin/amdgpu-exporter_1.2.0_ubuntu_24.04_amd64.deb

  build-device-metrics-exporter-docker-ubi9.4:
    commands: ["sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make && \
                            HOURLY_TAG_LABEL=$RELEASE IMAGE_TAG=latest make docker-cicd"]
    owners: ["email:prshanmug@amd.com"]
    artifacts:
        - /device-metrics-exporter/docker/exporter-latest.tar.gz
        - /device-metrics-exporter/tools/techsupport_dump.sh

  build-device-metrics-exporter-docker-azure:
    commands: ["sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make && \
                            DOCKER_CONTAINER_IMG=exporter-latest-azure HOURLY_TAG_LABEL=$RELEASE IMAGE_TAG=latest make docker-azure"]
    owners: ["email:prshanmug@amd.com"]
    artifacts:
        - /device-metrics-exporter/docker/exporter-latest-azure.tar.gz

  e2e-build-mock-exporter:
    commands: ["sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make e2e"]
    owners: ["email:prshanmug@amd.com"]
    artifacts:
        - /device-metrics-exporter/docker/exporter-mock-latest.tgz

  build-helm-artifact:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make helm-build"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:
    artifacts:
        - /device-metrics-exporter/helm-charts/amdgpu-metrics-exporter-charts-v1.2.0.tgz

  api-checks:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make checks"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:

  build-test-runner-docker:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && HOURLY_TAG_LABEL=$RELEASE IMAGE_TAG=latest make docker-test-runner-cicd"]
    owners: ["email:yan.sun3@amd.com"]
    artifacts:
        - /device-metrics-exporter/docker/testrunner/test-runner-latest.tar.gz

targets:
  device-metrics-sanity:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && \
                                    make unit-test"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:
    logfiles:
        - /device-metrics-exporter/exporter.log
    build-dependencies:
        - api-checks
        - build-helm-artifact
        - build-debian-package-ub22.04
        - build-debian-package-ub24.04
        - e2e-build-mock-exporter

  test-runner-sanity:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter"]
    owners: ["email:yan.sun3@amd.com"]
    area:
    sub-area:
    feature:
    logfiles:
        - /device-metrics-exporter/test-runner.log
    build-dependencies:
        - build-test-runner-docker
   
  copyright-checks:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make copyrights"]
    owners: ["email:sajmera@amd.com"]
    area:
    sub-area:
    feature:

image:
  bind_dir: "/device-metrics-exporter"
  work_dir: "/device-metrics-exporter"

jobs:
  asset-build:
    labels: ["CI-Sanity-Build"]

