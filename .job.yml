---
version: 2.0
builds:
  build-debian-package:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make pkg"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:
    artifacts:
        - /device-metrics-exporter/bin/amdgpu-exporter_1.0.0_amd64.deb

  build-device-metrics-exporter-docker:
    commands: ["sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make && \
                            HOURLY_TAG_LABEL=$RELEASE IMAGE_TAG=latest make docker-cicd"]
    owners: ["email:prshanmug@amd.com"]
    artifacts:
        - /device-metrics-exporter/docker/exporter-latest.tar.gz
        - /device-metrics-exporter/tools/techsupport_dump.sh

  build-mock-exporter:
    commands: ["sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make docker-mock"]
    owners: ["email:prshanmug@amd.com"]
    artifacts:
        - /device-metrics-exporter/docker/exporter-mock-latest.tgz

  build-helm-artifact:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make helm-build"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:
    artifacts:
        - /device-metrics-exporter/helm-charts/amdgpu-metrics-exporter-charts-v1.0.0.tgz

targets:
  api-checks:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make checks"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:

  device-metrics-unit-test:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && \
                                    make checks && \
                                    make unit-test"]
    owners: ["email:prshanmug@amd.com"]
    area:
    sub-area:
    feature:
    logfiles:
        - /device-metrics-exporter/exporter.log
   
  copyright-checks:
    commands: [ "/bin/sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && make copyrights"]
    owners: ["email:sajmera@amd.com"]
    area:
    sub-area:
    feature:

  e2e-test-mock-exporter:
    commands: ["sh", "-c", "cd /usr/src/github.com/pensando/device-metrics-exporter && ls docker -al && make e2e-test"]
    owners: ["email:prshanmug@amd.com"]
    build-dependencies:
        - build-helm-artifact
        - build-debian-package
        - build-mock-exporter

image:
  bind_dir: "/device-metrics-exporter"
  work_dir: "/device-metrics-exporter"

jobs:
  asset-build:
    labels: ["CI-Sanity-Build"]

